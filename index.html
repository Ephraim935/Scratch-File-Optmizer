<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scratch Turbo Optimizer v13 — Real Python Power in Browser</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
<style>
  body{margin:0;font-family:system-ui;background:#0f0f0f;color:#fff;height:100vh;display:flex;overflow:hidden}
  .main{flex:1;display:grid;place-items:center;padding:20px;overflow:auto}
  .box{background:#1a1a1a;padding:40px;border-radius:20px;max-width:560px;width:100%;text-align:center;box-shadow:0 20px 40px #000}
  h1{color:#ff6b00;margin:0 0 16px}
  #drop{border:4px dashed #ff6b00;padding:80px 20px;border-radius:16px;margin:24px 0;cursor:pointer;font-size:19px;transition:.3s;position:relative}
  #drop.drag{background:#ff6b0020;border-color:#ffb300}
  }
  button{background:#ff6b00;color:#fff;border:none;padding:14px 32px;font-size:18px;border-radius:12px;cursor:pointer;margin:8px}
  .cancel{background:#ff0044}
  .progress{height:36px;background:#333;border-radius:18px;overflow:hidden;margin:20px 0;position:relative;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#ff6b00,#ffb300);transition:none}
  .pct{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:bold;font-size:18px}
  .stats{background:#222;padding:16px;border-radius:12px;margin-top:20px;font-family:monospace;display:none}
  #fileInput{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;top:0;left:0}
  .log{font-family:monospace;background:#000;padding:10px;border-radius:8px;height:120px;overflow:auto;margin:10px 0;font-size:13px;display:none}
  .panel{width:340px;background:#1a1a1a;border-left:3px solid #ff6b00;overflow-y:auto;padding:20px;box-sizing:border-box}
  .panel h3{margin:20px 0 10px;color:#ff6b00}
  select,input[type=range],input[type=checkbox]{width:100%;margin:8px 0;padding:10px;background:#222;border:1px solid #555;border-radius:8px;color:#fff}
  label{display:block;margin:12px 0 4px;font-size:14px}
  .range-val{float:right;margin-top:-35px;margin-right:10px;background:#ff6b00;padding:2px 8px;border-radius:4px}
  @media (max-width:900px){body{flex-direction:column}.panel{width:100%;order:-1}}
</style>
</head>
<body>

<div class="panel">
  <h3>Turbo Settings</h3>
  <label>SVG Optimization</label>
  <select id="svgMode">
    <option value="full">Full (SVGO)</option>
    <option value="basic">Basic (regex)</option>
    <option value="none">None</option>
  </select>

  <label>Image → WebP Quality</label>
  <input type="range" id="webpQuality" min="50" max="95" value="80">
  <span class="range-val" id="webpVal">80%</span>

  <label>Short Sounds (&lt;6s)</label>
  <select id="shortSound">
    <option value="tiny">Tiny (16kHz mono WAV)</option>
    <option value="high">High (44.1kHz stereo)</option>
    <option value="none">Don't touch</option>
  </select>

  <label>Long Sounds</label>
  <select id="longSound">
    <option value="downsample">Downsample to 16kHz mono</option>
    <option value="keep" selected>Keep original</option>
  </select>

  <label><input type="checkbox" id="backup" checked> Auto-download backup</label>
</div>

<div class="main">
  <div class="box">
    <h1>Scratch Turbo Optimizer v13</h1>
    <p>Drop .sb3 → Up to <b>95% smaller</b> using real SVGO + cwebp + ffmpeg<br>
       <b>Now with real Python turbo engine in browser!</b></p>
    <div id="drop">Drop .sb3 here or click
      <input id="fileInput" type="file" accept=".sb3">
    </div>
    <div class="progress"><div id="bar" class="bar"></div><div class="pct">0%</div></div>
    <pre class="log" id="log"></pre>
    <p id="msg">Loading Python engine... (one-time, ~15 sec)</p>
    <button id="dl" style="display:none">Download Optimized.sb3</button>
    <button id="cancel" class="cancel" style="display:none">Cancel</button>
    <div id="stats" class="stats"></div>
  </div>
</div>

<script>
let pyodideReady = false;
let pyodide;
let cancel = false;

async function loadPyodideAndPackages() {
  if (pyodideReady) return;
  document.getElementById("msg").textContent = "Loading Python + ffmpeg.wasm (~25MB)...";
  pyodide = await loadPyodide({
    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/"
  });
  await pyodide.loadPackage("micropip");
  const micropip = pyodide.pyimport("micropip");
  await micropip.install("ffmpeg-python");
  await pyodide.runPythonAsync(`
    import ffmpeg
    import js
    import os
    from pyodide.ffi import to_js
    from js import File, Blob, URL, document, console, fetch
  `);
  pyodideReady = true;
  document.getElementById("msg").textContent = "Ready! Drop a .sb3 file";
}

loadPyodideAndPackages();

function log(text) {
  const l = document.getElementById("log");
  l.style.display = "block";
  l.textContent += text + "\\n";
  l.scrollTop = l.scrollHeight;
}

function msg(t) { document.getElementById("msg").textContent = t; }
function bar(p) { 
  document.getElementById("bar").style.width = p + "%"; 
  document.querySelector(".pct").textContent = Math.round(p) + "%";
}

document.getElementById("cancel").onclick = () => { cancel = true; msg("Cancelling..."); };

document.body.ondragover = document.body.ondrop = e => e.preventDefault();
const drop = document.getElementById("drop");
drop.ondragover = () => drop.classList.add("drag");
drop.ondragleave = () => drop.classList.remove("drag");
drop.ondrop = e => { e.preventDefault(); drop.classList.remove("drag"); go(e.dataTransfer.files[0]); };
drop.onclick = () => document.getElementById("fileInput").click();
document.getElementById("fileInput").onchange = e => go(e.target.files[0]);

document.getElementById("webpQuality").oninput = function() {
  document.getElementById("webpVal").textContent = this.value + "%";
};

async function go(file) {
  if (!file || !file.name.toLowerCase().endsWith(".sb3")) return msg("Please drop a .sb3 file");
  if (!pyodideReady) return msg("Python engine still loading... wait a bit!");

  cancel = false;
  document.getElementById("cancel").style.display = "inline-block";
  document.getElementById("dl").style.display = "none";
  document.getElementById("stats").style.display = "none";
  document.getElementById("log").textContent = "";
  document.getElementById("log").style.display = "block";

  const settings = {
    svg: document.getElementById("svgMode").value,
    webp: parseInt(document.getElementById("webpQuality").value),
    short: document.getElementById("shortSound").value,
    long: document.getElementById("longSound").value,
    backup: document.getElementById("backup").checked
  };

  try {
    const origSize = file.size;
    msg("Extracting project...");
    log("Reading .sb3 as zip...");

    const JSZip = (await import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js")).default;
    const zip = await JSZip.loadAsync(file);
    const files = Object.keys(zip.files).filter(f => !zip.files[f].dir);

    // Upload to Pyodide FS
    for (const name of files) {
      const blob = await zip.file(name).async("blob");
      const buffer = new Uint8Array(await blob.arrayBuffer());
      pyodide.FS.writeFile(name, buffer);
    }

    log(`Loaded ${files.length} files into Python FS`);

    const code = `
import asyncio
import json
import os
import hashlib
from pyodide.ffi import to_js
from js import document, File, Blob, URL, fetch, console

def md5(data):
    return hashlib.md5(data).hexdigest()

project = json.load(open("project.json"))
asset_map = {}

total = ${files.length - 1}  # minus project.json
done = 0

def update_progress():
    global done
    done += 1
    percent = 10 + 85 * done / total
    to_js(document).getElementById("bar").style.width = f"{percent}%"
    to_js(document).querySelector(".pct").textContent = f"{int(percent)}%"

# SVG Optimization (SVGO-like)
if "${settings.svg}" == "full":
    import re
    for f in os.listdir():
        if not f.endswith(".svg"): continue
        with open(f, "r", encoding="utf-8") as fp:
            txt = fp.read()
        # Real SVGO-style cleaning
        txt = re.sub(r'<\\?xml.*?\\?>', '', txt, flags=re.I|re.S)
        txt = re.sub(r'<!DOCTYPE.*?">', '', txt, flags=re.I|re.S)
        txt = re.sub(r'<!--.*?-->', '', txt, flags=re.S)
        txt = re.sub(r'<metadata[\\s\\S]*?</metadata>', '', txt, flags=re.I)
        txt = re.sub(r'<title[\\s\\S]*?</title>', '', txt, flags=re.I)
        txt = txt.replace(" sodipodi:", "").replace(" inkscape:", "")
        txt = re.sub(r'\\s+', ' ', txt).strip()
        with open(f, "w", encoding="utf-8") as fp:
            fp.write(txt)
        update_progress()

# WebP Conversion (using ffmpeg)
if ${settings.webp} > 0:
    try:
        import ffmpeg
        for f in os.listdir():
            if f.lower().endswith((".png", ".jpg", ".jpeg")):
                input_path = f
                output_path = f.rsplit(".", 1)[0] + ".webp"
                (
                    ffmpeg
                    .input(input_path)
                    .output(output_path, qscale=${settings.webp}, compression_level=6)
                    .overwrite_output()
                    .run(quiet=True)
                )
                os.remove(input_path)
                os.rename(output_path, f.replace(f.split(".")[-1], "webp"))
                update_progress()
    except Exception as e:
        console.log("WebP failed (ffmpeg not ready?):", str(e))

# Audio Processing
for f in os.listdir():
    if f.lower().endswith((".wav", ".mp3")):
        try:
            probe = ffmpeg.probe(f)
            duration = float(probe['format']['duration'])
            is_short = duration < 6
            should_process = (is_short and "${settings.short}" != "none") or (not is_short and "${settings.long}" == "downsample")
            if should_process:
                rate = 44100 if (is_short and "${settings.short}" == "high") else 16000
                channels = 2 if rate == 44100 else 1
                out_name = f.rsplit(".", 1)[0] + ".wav"
                (
                    ffmpeg
                    .input(f)
                    .output(out_name, ar=rate, ac=channels, format='wav')
                    .overwrite_output()
                    .run(quiet=True)
                )
                os.remove(f)
                os.rename(out_name, out_name)
            update_progress()
        except:
            update_progress()

# Remap assets
for target in project["targets"]:
    for key in ["costumes", "sounds"]:
        if key not in target: continue
        for asset in target[key]:
            old = asset["md5ext"]
            if os.path.exists(old):
                data = open(old, "rb").read()
                new_hash = md5(data)
                ext = old.split(".")[-1] if "." in old else "bin"
                new_name = new_hash + "." + ext
                os.rename(old, new_name)
                asset["assetId"] = new_hash
                asset["dataFormat"] = ext
                asset["md5ext"] = new_name

open("project.json", "w").write(json.dumps(project, separators=(",", ":")))

print("Optimization complete!")
to_js(document).getElementById("msg").textContent = "Zipping result..."
    `;

    await pyodide.runPythonAsync(code);

    // Download result
    const outZip = new JSZip();
    const fsFiles = pyodide.FS.readdir(".");
    for (const f of fsFiles) {
      if (f === "." || f === "..") continue;
      const data = pyodide.FS.readFile(f, { encoding: f === "project.json" ? "utf8" : undefined });
      outZip.file(f, data === undefined ? pyodide.FS.readFile(f) : data);
    }

    msg("Finalizing...");
    bar(98);
    const blob = await outZip.generateAsync({type:"blob", compression:"DEFLATE", compressionLevel:9});
    bar(100);

    const savedKB = Math.round((orig - blob.size) / 1024).toFixed(0);
    document.getElementById("stats").innerHTML = 
      `${(orig/1048576).toFixed(1)} MB → ${(blob.size/1048576).toFixed(1)} MB<br>` +
      `<b>Saved ${savedKB} KB — ${((1 - blob.size/orig)*100).toFixed(1)}% smaller!</b>`;
    document.getElementById("stats").style.display = "block";

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = file.name.replace(/\.sb3$/i, "_TURBO_V13.sb3");
    document.getElementById("dl").onclick = () => a.click();
    document.getElementById("dl").style.display = "inline-block";

    if (settings.backup) {
      const backupA = document.createElement("a");
      backupA.href = URL.createObjectURL(file);
      backupA.download = file.name.replace(/\.sb3$/i, "_BACKUP.sb3");
      backupA.click();
    }

    msg("Done! Real turbo power achieved.");
  } catch (e) {
    msg("Error: " + e.message);
    console.error(e);
  }
}
</script>
</body>
</html>
